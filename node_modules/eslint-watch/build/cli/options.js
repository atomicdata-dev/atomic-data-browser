"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash.unionwith"));

var _optionator = _interopRequireDefault(require("optionator"));

var _lodash2 = _interopRequireDefault(require("lodash.kebabcase"));

var _logger = require("../logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const logger = (0, _logger.createLogger)('options');
const settings = {
  prepend: 'esw [options] [file.js ...] [dir ...]',
  concatRepeatedArrays: true,
  mergeRepeatedObjects: true
};
const defaultOptions = [{
  heading: 'ESW Options'
}, {
  option: 'help',
  alias: 'h',
  type: 'Boolean',
  description: 'Show help'
}, {
  option: 'watch',
  alias: 'w',
  type: 'Boolean',
  description: 'Enable file watch'
}, {
  option: 'changed',
  type: 'Boolean',
  description: 'Enables single file linting while watch is enabled'
}, {
  option: 'clear',
  type: 'Boolean',
  description: 'Clear terminal when running lint'
}, {
  option: 'version',
  type: 'Boolean',
  alias: 'v',
  description: 'Prints Eslint-Watch Version'
}, {
  option: 'versions',
  type: 'Boolean',
  description: 'Prints Eslint-Watch and Eslint Versions'
}, {
  option: 'watch-ignore',
  type: 'RegExp',
  description: 'Regex string of folders to ignore when watching - default: /.git|node_modules|bower_components|.eslintcache/'
}, {
  option: 'watch-delay',
  type: 'Int',
  description: 'Delay(ms) for watcher to wait to trigger re-lint',
  default: '300'
}, {
  heading: 'Basic configuration'
}, {
  option: 'ext',
  type: '[String]',
  description: 'Specify JavaScript file extensions',
  default: '.js'
}];

function areEqual(opt1, opt2) {
  if (opt1.heading && opt2.heading) {
    return opt1.heading === opt2.heading;
  }

  return opt1.alias === opt2.alias && opt1.option === opt2.option && opt1.type === opt2.type;
}

var _default = {
  get eswOptions() {
    return [...defaultOptions];
  },

  createOptions(eswOptions, eslintOptions = []) {
    const mergedOptions = (0, _lodash.default)(eswOptions, eslintOptions, areEqual);
    logger.debug(mergedOptions);
    const opsor = (0, _optionator.default)({ ...settings,
      options: mergedOptions
    });
    return {
      helpText: opsor.generateHelp(),

      parse(rawArgs) {
        const options = opsor.parse(rawArgs, {
          slice: 0
        });
        const dirs = options._;

        if (dirs.length === 0) {
          dirs.push(_path.default.resolve('.'));
        }

        options._ = dirs;
        return options;
      }

    };
  },

  getCli(options) {
    const eswKeys = ['watch', 'versions', 'version', 'clear', 'changed', 'watchIgnore', 'watchDelay'];
    return Object.entries(options).reduce((acc, [key, value]) => {
      if (eswKeys.includes(key)) {
        return acc;
      }

      if (key === '_') {
        return acc;
      }

      if (key === 'rule') {
        Object.keys(value).forEach(ruleKey => {
          acc.flags.push('--rule', `${ruleKey}: ${JSON.stringify(value[ruleKey]).replace(/"/g, '')}`);
        });
        return acc;
      }

      if (typeof value === 'boolean') {
        acc.flags.push(`--${value ? '' : 'no-'}${(0, _lodash2.default)(key)}`);
      } else {
        acc.flags.push(`--${(0, _lodash2.default)(key)}`);
        acc.flags.push(value);
      }

      return acc;
    }, {
      flags: [],
      dirs: options._ || []
    });
  }

};
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvb3B0aW9ucy5qcyJdLCJuYW1lcyI6WyJsb2dnZXIiLCJzZXR0aW5ncyIsInByZXBlbmQiLCJjb25jYXRSZXBlYXRlZEFycmF5cyIsIm1lcmdlUmVwZWF0ZWRPYmplY3RzIiwiZGVmYXVsdE9wdGlvbnMiLCJoZWFkaW5nIiwib3B0aW9uIiwiYWxpYXMiLCJ0eXBlIiwiZGVzY3JpcHRpb24iLCJkZWZhdWx0IiwiYXJlRXF1YWwiLCJvcHQxIiwib3B0MiIsImVzd09wdGlvbnMiLCJjcmVhdGVPcHRpb25zIiwiZXNsaW50T3B0aW9ucyIsIm1lcmdlZE9wdGlvbnMiLCJkZWJ1ZyIsIm9wc29yIiwib3B0aW9ucyIsImhlbHBUZXh0IiwiZ2VuZXJhdGVIZWxwIiwicGFyc2UiLCJyYXdBcmdzIiwic2xpY2UiLCJkaXJzIiwiXyIsImxlbmd0aCIsInB1c2giLCJwYXRoIiwicmVzb2x2ZSIsImdldENsaSIsImVzd0tleXMiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwiYWNjIiwia2V5IiwidmFsdWUiLCJpbmNsdWRlcyIsImtleXMiLCJmb3JFYWNoIiwicnVsZUtleSIsImZsYWdzIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlcGxhY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLE1BQU0sR0FBRywwQkFBYSxTQUFiLENBQWY7QUFFQSxNQUFNQyxRQUFRLEdBQUc7QUFDZkMsRUFBQUEsT0FBTyxFQUFFLHVDQURNO0FBRWZDLEVBQUFBLG9CQUFvQixFQUFFLElBRlA7QUFHZkMsRUFBQUEsb0JBQW9CLEVBQUU7QUFIUCxDQUFqQjtBQU1BLE1BQU1DLGNBQWMsR0FBRyxDQUNyQjtBQUNFQyxFQUFBQSxPQUFPLEVBQUU7QUFEWCxDQURxQixFQUlyQjtBQUNFQyxFQUFBQSxNQUFNLEVBQUUsTUFEVjtBQUVFQyxFQUFBQSxLQUFLLEVBQUUsR0FGVDtBQUdFQyxFQUFBQSxJQUFJ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QVAsS0FBaUIsU0FBckIsRUFBZ0M7QUFDOUJGLFFBQUFBLEdBQUcsQ0FBQ08sS0FBSixDQUFVZixJQUFWLENBQWdCLEtBQUlVLEtBQUssR0FBRyxFQUFILEdBQVEsS0FBTSxHQUFFLHNCQUFNRCxHQUFOLENBQVcsRUFBcEQ7QUFDRCxPQUZELE1BRU87QUFDTEQsUUFBQUEsR0FBRyxDQUFDTyxLQUFKLENBQVVmLElBQVYsQ0FBZ0IsS0FBSSxzQkFBTVMsR0FBTixDQUFXLEVBQS9CO0FBQ0FELFFBQUFBLEdBQUcsQ0FBQ08sS0FBSixDQUFVZixJQUFWLENBQWVVLEtBQWY7QUFDRDs7QUFFRCxhQUFPRixHQUFQO0FBQ0QsS0ExQkksRUEyQkw7QUFDRU8sTUFBQUEsS0FBSyxFQUFFLEVBRFQ7QUFFRWxCLE1BQUFBLElBQUksRUFBRU4sT0FBTyxDQUFDTyxDQUFSLElBQWE7QUFGckIsS0EzQkssQ0FBUDtBQWdDRDs7QUE1RFksQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHVuaW9ud2l0aCBmcm9tICdsb2Rhc2gudW5pb253aXRoJztcbmltcG9ydCBvcHRpb25hdG9yIGZyb20gJ29wdGlvbmF0b3InO1xuaW1wb3J0IGtlYmFiIGZyb20gJ2xvZGFzaC5rZWJhYmNhc2UnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcblxuY29uc3QgbG9nZ2VyID0gY3JlYXRlTG9nZ2VyKCdvcHRpb25zJyk7XG5cbmNvbnN0IHNldHRpbmdzID0ge1xuICBwcmVwZW5kOiAnZXN3IFtvcHRpb25zXSBbZmlsZS5qcyAuLi5dIFtkaXIgLi4uXScsXG4gIGNvbmNhdFJlcGVhdGVkQXJyYXlzOiB0cnVlLFxuICBtZXJnZVJlcGVhdGVkT2JqZWN0czogdHJ1ZSxcbn07XG5cbmNvbnN0IGRlZmF1bHRPcHRpb25zID0gW1xuICB7XG4gICAgaGVhZGluZzogJ0VTVyBPcHRpb25zJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ2hlbHAnLFxuICAgIGFsaWFzOiAnaCcsXG4gICAgdHlwZTogJ0Jvb2xlYW4nLFxuICAgIGRlc2NyaXB0aW9uOiAnU2hvdyBoZWxwJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ3dhdGNoJyxcbiAgICBhbGlhczogJ3cnLFxuICAgIHR5cGU6ICdCb29sZWFuJyxcbiAgICBkZXNjcmlwdGlvbjogJ0VuYWJsZSBmaWxlIHdhdGNoJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ2NoYW5nZWQnLFxuICAgIHR5cGU6ICdCb29sZWFuJyxcbiAgICBkZXNjcmlwdGlvbjogJ0VuYWJsZXMgc2luZ2xlIGZpbGUgbGludGluZyB3aGlsZSB3YXRjaCBpcyBlbmFibGVkJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ2NsZWFyJyxcbiAgICB0eXBlOiAnQm9vbGVhbicsXG4gICAgZGVzY3JpcHRpb246ICdDbGVhciB0ZXJtaW5hbCB3aGVuIHJ1bm5pbmcgbGludCcsXG4gIH0sXG4gIHtcbiAgICBvcHRpb246ICd2ZXJzaW9uJyxcbiAgICB0eXBlOiAnQm9vbGVhbicsXG4gICAgYWxpYXM6ICd2JyxcbiAgICBkZXNjcmlwdGlvbjogJ1ByaW50cyBFc2xpbnQtV2F0Y2ggVmVyc2lvbicsXG4gIH0sXG4gIHtcbiAgICBvcHRpb246ICd2ZXJzaW9ucycsXG4gICAgdHlwZTogJ0Jvb2xlYW4nLFxuICAgIGRlc2NyaXB0aW9uOiAnUHJpbnRzIEVzbGludC1XYXRjaCBhbmQgRXNsaW50IFZlcnNpb25zJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ3dhdGNoLWlnbm9yZScsXG4gICAgdHlwZTogJ1JlZ0V4cCcsXG4gICAgZGVzY3JpcHRpb246ICdSZWdleCBzdHJpbmcgb2YgZm9sZGVycyB0byBpZ25vcmUgd2hlbiB3YXRjaGluZyAtIGRlZmF1bHQ6IC8uZ2l0fG5vZGVfbW9kdWxlc3xib3dlcl9jb21wb25lbnRzfC5lc2xpbnRjYWNoZS8nLFxuICB9LFxuICB7XG4gICAgb3B0aW9uOiAnd2F0Y2gtZGVsYXknLFxuICAgIHR5cGU6ICdJbnQnLFxuICAgIGRlc2NyaXB0aW9uOiAnRGVsYXkobXMpIGZvciB3YXRjaGVyIHRvIHdhaXQgdG8gdHJpZ2dlciByZS1saW50JyxcbiAgICBkZWZhdWx0OiAnMzAwJyxcbiAgfSxcbiAge1xuICAgIGhlYWRpbmc6ICdCYXNpYyBjb25maWd1cmF0aW9uJyxcbiAgfSxcbiAge1xuICAgIG9wdGlvbjogJ2V4dCcsXG4gICAgdHlwZTogJ1tTdHJpbmddJyxcbiAgICBkZXNjcmlwdGlvbjogJ1NwZWNpZnkgSmF2YVNjcmlwdCBmaWxlIGV4dGVuc2lvbnMnLFxuICAgIGRlZmF1bHQ6ICcuanMnLFxuICB9LFxuXTtcblxuZnVuY3Rpb24gYXJlRXF1YWwob3B0MSwgb3B0Mikge1xuICBpZiAob3B0MS5oZWFkaW5nICYmIG9wdDIuaGVhZGluZykge1xuICAgIHJldHVybiBvcHQxLmhlYWRpbmcgPT09IG9wdDIuaGVhZGluZztcbiAgfVxuICByZXR1cm4gb3B0MS5hbGlhcyA9PT0gb3B0Mi5hbGlhcyAmJiBvcHQxLm9wdGlvbiA9PT0gb3B0Mi5vcHRpb24gJiYgb3B0MS50eXBlID09PSBvcHQyLnR5cGU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgZ2V0IGVzd09wdGlvbnMoKSB7XG4gICAgcmV0dXJuIFsuLi5kZWZhdWx0T3B0aW9uc107XG4gIH0sXG4gIGNyZWF0ZU9wdGlvbnMoZXN3T3B0aW9ucywgZXNsaW50T3B0aW9ucyA9IFtdKSB7XG4gICAgY29uc3QgbWVyZ2VkT3B0aW9ucyA9IHVuaW9ud2l0aChlc3dPcHRpb25zLCBlc2xpbnRPcHRpb25zLCBhcmVFcXVhbCk7XG4gICAgbG9nZ2VyLmRlYnVnKG1lcmdlZE9wdGlvbnMpO1xuICAgIGNvbnN0IG9wc29yID0gb3B0aW9uYXRvcih7IC4uLnNldHRpbmdzLCBvcHRpb25zOiBtZXJnZWRPcHRpb25zIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhlbHBUZXh0OiBvcHNvci5nZW5lcmF0ZUhlbHAoKSxcbiAgICAgIHBhcnNlKHJhd0FyZ3MpIHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IG9wc29yLnBhcnNlKHJhd0FyZ3MsIHsgc2xpY2U6IDAgfSk7XG4gICAgICAgIGNvbnN0IGRpcnMgPSBvcHRpb25zLl87XG5cbiAgICAgICAgaWYgKGRpcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgZGlycy5wdXNoKHBhdGgucmVzb2x2ZSgnLicpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9wdGlvbnMuXyA9IGRpcnM7XG5cbiAgICAgICAgcmV0dXJuIG9wdGlvbnM7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG4gIGdldENsaShvcHRpb25zKSB7XG4gICAgY29uc3QgZXN3S2V5cyA9IFsnd2F0Y2gnLCAndmVyc2lvbnMnLCAndmVyc2lvbicsICdjbGVhcicsICdjaGFuZ2VkJywgJ3dhdGNoSWdub3JlJywgJ3dhdGNoRGVsYXknXTtcblxuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhvcHRpb25zKS5yZWR1Y2UoXG4gICAgICAoYWNjLCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgaWYgKGVzd0tleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoa2V5ID09PSAnXycpIHtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGtleSA9PT0gJ3J1bGUnKSB7XG4gICAgICAgICAgT2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goKHJ1bGVLZXkpID0+IHtcbiAgICAgICAgICAgIGFjYy5mbGFncy5wdXNoKCctLXJ1bGUnLCBgJHtydWxlS2V5fTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZVtydWxlS2V5XSkucmVwbGFjZSgvXCIvZywgJycpfWApO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykge1xuICAgICAgICAgIGFjYy5mbGFncy5wdXNoKGAtLSR7dmFsdWUgPyAnJyA6ICduby0nfSR7a2ViYWIoa2V5KX1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhY2MuZmxhZ3MucHVzaChgLS0ke2tlYmFiKGtleSl9YCk7XG4gICAgICAgICAgYWNjLmZsYWdzLnB1c2godmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGZsYWdzOiBbXSxcbiAgICAgICAgZGlyczogb3B0aW9ucy5fIHx8IFtdLFxuICAgICAgfVxuICAgICk7XG4gIH0sXG59O1xuIl19